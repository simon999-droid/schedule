<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äºŒå´™åœ‹å°å®šæœŸè©•é‡æ™‚ç¨‹</title>
    <style>
        /* --- å…¨åŸŸè¨­å®š --- */
        :root {
            /* åˆ†é›¢å·¦å³èƒŒæ™¯è®Šæ•¸ */
            --left-bg-color: #ffffff;
            --right-bg-color: #fdf6e3;
            
            --panel-bg: #ffffff;
            --primary-red: #e74c3c;
            --primary-green: #2ecc71;
            --primary-blue: #3498db; 
            --border-color: #ddd;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        body {
            margin: 0;
            padding: 0;
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            background-color: var(--right-bg-color); /* Body è·Ÿéš¨å³å´èƒŒæ™¯ */
            height: 100vh;
            display: flex;
            overflow: hidden;
            transition: background-color 0.3s;
        }

        /* --- è‰²ç¥¨å½ˆçª—æ¨£å¼ (New) --- */
        .palette-popup {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none; /* é è¨­éš±è— */
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            width: 140px;
        }
        
        .palette-popup.show {
            display: grid;
        }

        .color-swatch {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #eee;
            cursor: pointer;
            transition: transform 0.1s, border-color 0.2s;
        }

        .color-swatch:hover {
            transform: scale(1.1);
            border-color: #aaa;
        }

        .custom-color-btn {
            grid-column: span 3;
            margin-top: 5px;
            padding: 5px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            text-align: center;
        }
        .custom-color-btn:hover { background: #e0e0e0; }


        /* --- P1å„ªåŒ–: ç•¶å‰ç§‘ç›®é«˜äº®å‹•ç•« --- */
        @keyframes pulse-border {
            0% { box-shadow: inset 0 0 0 2px rgba(231, 76, 60, 0.2); }
            50% { box-shadow: inset 0 0 0 4px rgba(231, 76, 60, 0.8); background-color: rgba(255, 245, 230, 0.5); }
            100% { box-shadow: inset 0 0 0 2px rgba(231, 76, 60, 0.2); }
        }

        .active-exam-row {
            animation: pulse-border 2s infinite;
            position: relative;
            z-index: 5;
            border-left: 5px solid var(--primary-red) !important;
        }

        /* --- P0å„ªåŒ–: æ‰‹æ©ŸéŸ¿æ‡‰å¼è¨­å®š --- */
        @media (max-width: 768px) {
            body {
                overflow: auto; 
                flex-direction: column;
                height: auto; 
            }
            .container {
                flex-direction: column;
                height: auto;
            }
            .left-panel, .right-panel {
                width: 100%;
                height: auto;
                min-height: 50vh;
                border-right: none;
                border-bottom: 2px solid #e0e0e0;
                padding: 10px; 
            }
            .header-controls {
                justify-content: space-between;
            }
            h1 { font-size: 20px; width: 100%; margin-bottom: 10px; }
            .btn { padding: 8px; font-size: 13px; }
            
            th, td { padding: 6px 2px; font-size: 14px; }
            .manage-btns button { padding: 4px; font-size: 12px; }
            .time-input-group { flex-direction: column; gap: 2px; }
        }

        /* --- é€šç”¨é®ç½©æ¨£å¼ (ç™»å…¥ & ä½¿ç”¨è€…ç®¡ç†) --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(253, 246, 227, 0.95);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        
        .modal-overlay.hidden { display: none; }

        .login-box, .modal-box {
            background: white;
            padding: 30px; 
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            width: 90%; 
            max-width: 350px;
            text-align: center;
            border-top: 5px solid var(--primary-green);
            position: relative;
        }
        
        .modal-box.wide { max-width: 600px; }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #aaa;
        }
        .modal-close:hover { color: #333; }

        .login-title, .modal-title {
            color: #2c3e50;
            font-size: 24px;
            margin-bottom: 25px;
            font-weight: bold;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #7f8c8d;
            font-size: 14px;
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box; 
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-green);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 15px;
            transition: background 0.3s;
        }

        .login-btn:hover { background-color: #27ae60; }

        .guest-btn {
            background-color: transparent;
            color: #7f8c8d;
            border: 1px solid #ddd;
        }

        .guest-btn:hover { background-color: #f5f5f5; color: #333; }
        
        .error-msg {
            color: var(--primary-red);
            font-size: 14px;
            margin-bottom: 15px;
            min-height: 20px;
        }
        
        /* --- ä½¿ç”¨è€…ç®¡ç†è¡¨æ ¼æ¨£å¼ --- */
        .user-list-table {
            width: 100%;
            margin-bottom: 20px;
            border-collapse: collapse;
            font-size: 14px;
        }
        .user-list-table th, .user-list-table td {
            padding: 8px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }
        .user-list-table th { color: #555; background-color: #f9f9f9; }
        
        .new-user-form {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            align-items: center;
        }
        .new-user-form input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 30%;
        }

        /* --- æ¬Šé™æ§åˆ¶ Class --- */
        .hidden { display: none !important; }
        
        body.guest-mode .admin-only {
            display: none !important;
        }
        body.guest-mode .input-disabled-look {
            background: transparent;
            border: none;
            color: #333;
            pointer-events: none; 
        }

        /* --- ä½ˆå±€ --- */
        .container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        /* èª¿æ•´å·¦å³æ¬„æ¯”ä¾‹ï¼šå·¦æ¬„åŠ å¯¬ (flex: 3)ï¼Œå³æ¬„ç¸®æ¸› (flex: 2) */
        .left-panel {
            flex: 3;
            padding: 20px;
            overflow-y: auto;
            position: relative;
            border-right: 2px solid #e0e0e0;
            background: var(--left-bg-color); 
            transition: background-color 0.3s;
        }

        .right-panel {
            flex: 2;
            padding: 20px;
            overflow-y: auto;
            position: relative;
            background-color: var(--right-bg-color); 
            transition: background-color 0.3s;
        }

        /* --- å·¦å´ï¼šè¡¨æ ¼èˆ‡æ§åˆ¶åˆ— --- */
        .header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        h1 {
            color: #d81b60;
            margin: 0;
            font-size: 24px;
            margin-right: 20px;
        }

        .btn {
            border: 1px solid #ccc;
            background: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
            user-select: none;
        }

        .btn:hover:not(:disabled) { background: #f5f5f5; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn.green { background: var(--primary-green); color: white; border: none; }
        .btn.orange { background: #f39c12; color: white; border: none; }
        .btn.red { background: var(--primary-red); color: white; border: none; }
        .btn.blue { background: var(--primary-blue); color: white; border: none; } 
        .btn-group { display: flex; gap: 2px; }

        input[type="color"] {
            visibility: hidden;
            width: 0;
            height: 0;
            padding: 0;
            border: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid var(--border-color);
            background: rgba(255, 255, 255, 0.5); /* è®“èƒŒæ™¯è‰²é€å‡ºä¾†ä¸€é» */
        }

        th, td {
            border: 1px solid var(--border-color);
            padding: 12px;
            text-align: center;
            vertical-align: middle;
        }

        th {
            background-color: rgba(249, 249, 249, 0.9);
            font-weight: bold;
            color: #555;
        }

        /* æ™‚é–“è¼¸å…¥å„ªåŒ– */
        .time-input-group {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .time-part-input {
            width: auto;
            padding: 4px;
            border: 1px solid transparent;
            border-radius: 4px;
            background: #f9f9f9;
            font-family: monospace;
            text-align: center;
            cursor: pointer;
        }
        .time-part-input:focus { border: 1px solid var(--primary-green); outline: none; background: white; }
        
        .subject-input {
            width: 90%;
            padding: 5px;
            border: 1px solid transparent;
            text-align: center;
            background: transparent;
            font-size: 16px; 
        }
        .subject-input:focus { border: 1px solid #aaa; outline: none; }
        .subject-input:disabled { color: inherit; -webkit-text-fill-color: inherit; opacity: 1; }
        
        .row-highlight { color: var(--primary-red); font-weight: bold; }

        /* èƒ½é‡æ¢ (Progress Bar) å„ªåŒ– */
        .energy-bar-container {
            width: 100%;
            height: 24px; 
            background-color: #eee;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .energy-bar-fill {
            height: 100%;
            background-color: #bdc3c7; 
            width: 0%;
            transition: width 1s linear, background-color 0.3s;
        }

        .countdown-text {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px; /* åŠ å¤§å€’æ•¸æ–‡å­— */
            font-weight: bold;
            color: #333;
            text-shadow: 0 0 2px rgba(255,255,255,0.8);
            pointer-events: none; 
            z-index: 2;
        }

        .manage-btns .btn-sm {
            padding: 4px 8px;
            margin: 0 2px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .manage-btns .btn-del { 
            color: var(--primary-red); 
            border-color: #fadbd8;
            background-color: #fdedec;
        }
        .manage-btns .btn-del:hover {
            background-color: #fadbd8;
        }

        /* --- å³å´ï¼šå°å·¥å…·å€ --- */
        .widget-toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .draggable {
            position: absolute;
            cursor: move;
            box-shadow: var(--shadow);
            user-select: none;
            z-index: 10;
        }
        .draggable.locked { cursor: default; } 

        .close-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 20px;
            height: 20px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 18px;
            font-size: 14px;
            cursor: pointer;
            display: none; 
            z-index: 20;
        }
        .draggable:hover .close-btn { display: block; }
        .draggable.locked:hover .close-btn { display: none !important; }

        .sticky-note {
            width: 200px;
            height: 200px;
            background: #fff7d1;
            border-radius: 5px 5px 20px 5px;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sticky-note textarea {
            width: 100%;
            height: 100%;
            background: transparent;
            border: none;
            resize: none;
            font-size: 16px;
            outline: none;
        }
        .sticky-note textarea:disabled { color: black; }

        .bulletin-board {
            width: 220px;
            min-height: 150px;
            background: white;
            border-left: 5px solid var(--primary-red);
            border-radius: 5px;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        .bulletin-title { font-weight: bold; color: var(--primary-red); border-bottom: 1px solid #eee; margin-bottom: 5px; outline: none;}
        .bulletin-content { flex: 1; outline: none; min-height: 100px; }

        .digital-clock {
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 24px;
            font-weight: bold;
            font-family: monospace;
        }
        .clock-white { background: white; color: #333; }
        .clock-black { background: #333; color: #0f0; }

        /* --- æ™‚å°šæŒ‡é‡æ™‚é˜è¨­è¨ˆ (New) --- */
        .analog-clock {
            width: 200px;
            height: 200px;
            background: #fcfcfc;
            border-radius: 50%;
            /* æ¨¡æ“¬é‡‘å±¬é‚Šæ¡†èˆ‡é™°å½± */
            border: 8px solid #4a4a4a;
            box-shadow: 
                0 0 0 2px #d6d6d6, /* å¤–åœˆäº®é‚Š */
                inset 0 0 20px rgba(0,0,0,0.1), /* å…§éƒ¨æ·±åº¦ */
                0 10px 20px rgba(0,0,0,0.2); /* æ‡¸æµ®é™°å½± */
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* å“ç‰Œå­—æ¨£ */
        .clock-branding {
            position: absolute;
            top: 25%;
            width: 100%;
            text-align: center;
            font-size: 10px;
            letter-spacing: 2px;
            color: #999;
            font-family: "Arial", sans-serif;
            font-weight: bold;
            z-index: 1;
        }

        /* åˆ»åº¦ç·š */
        .clock-marker {
            position: absolute;
            width: 2px;
            height: 100%;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            /* é€éæ¼¸å±¤åªé¡¯ç¤ºé ­å°¾çš„åˆ»åº¦ */
            background: transparent;
            pointer-events: none;
        }
        
        /* æ•´é»åˆ»åº¦ (ç²—) */
        .marker-hour::before, .marker-hour::after {
            content: '';
            position: absolute;
            width: 4px;
            height: 12px;
            background: #333;
            left: -1px;
        }
        .marker-hour::before { top: 6px; }
        .marker-hour::after { bottom: 6px; }

        /* åˆ†é˜åˆ»åº¦ (ç´°) */
        .marker-minute::before, .marker-minute::after {
            content: '';
            position: absolute;
            width: 1px;
            height: 6px;
            background: #999;
            left: 0.5px;
        }
        .marker-minute::before { top: 6px; }
        .marker-minute::after { bottom: 6px; }

        /* é€šç”¨æŒ‡é‡è¨­å®š */
        .hand {
            position: absolute;
            bottom: 50%;
            left: 50%;
            transform-origin: bottom center;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 2;
        }

        /* æ™‚é‡ */
        .hour-hand {
            width: 6px;
            height: 55px; /* ç¸®çŸ­ */
            background: #2c3e50;
            transform: translateX(-50%);
            /* åŠå½¢æŒ‡é‡è¨­è¨ˆ */
            clip-path: polygon(50% 0%, 100% 20%, 100% 100%, 0% 100%, 0% 20%);
        }

        /* åˆ†é‡ */
        .min-hand {
            width: 4px;
            height: 80px;
            background: #34495e;
            transform: translateX(-50%);
            border-radius: 2px;
        }

        /* ç§’é‡ */
        .sec-hand {
            width: 2px;
            height: 90px;
            background: #e74c3c;
            transform: translateX(-50%);
            transform-origin: 50% 80%; /* é‡å¿ƒåç§» */
            bottom: calc(50% - 18px); /* 18px = 20% of 90px (å°¾å·´é•·åº¦) */
            z-index: 3;
        }
        
        /* ç§’é‡å°¾ç«¯å¹³è¡¡éŒ˜ */
        .sec-hand::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: #e74c3c;
            border-radius: 50%;
            top: 80%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* ä¸­å¿ƒè“‹ */
        .clock-center-cap {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #333; /* é‡‘å±¬è³ªæ„Ÿ */
            border: 2px solid #e74c3c;
            border-radius: 50%;
            z-index: 4;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        /* --- åˆ†é æ¨£å¼ (New) --- */
        .tabs-container {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .tab-btn {
            padding: 8px 20px;
            border: 1px solid #ddd;
            background: #f0f0f0;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            font-weight: bold;
            color: #555;
            transition: all 0.2s;
            border-bottom: none;
        }
        
        .tab-btn.active {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }
        
        .tab-btn:hover:not(.active) {
            background: #e0e0e0;
        }

    </style>
</head>
<body>

<!-- ç™»å…¥é®ç½© -->
<div id="loginOverlay" class="modal-overlay">
    <div class="login-box">
        <div class="login-title">äºŒå´™åœ‹å°å®šæœŸè©•é‡æ™‚ç¨‹</div>
        <div class="error-msg" id="loginError"></div>
        <div class="error-msg" id="loadingMsg" style="color: #2ecc71; display:none;">æ­£åœ¨å¾é›²ç«¯è¼‰å…¥è¨­å®š...</div>
        
        <div class="input-group">
            <label>å¸³è™Ÿ</label>
            <input type="text" id="usernameInput" placeholder="ä¾‹å¦‚: admin">
        </div>
        <div class="input-group">
            <label>å¯†ç¢¼</label>
            <input type="password" id="passwordInput" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
        </div>
        
        <button class="login-btn" onclick="handleLogin()">ç™»å…¥</button>
        <button class="login-btn guest-btn" onclick="handleGuestLogin()">è¨ªå®¢ç™»å…¥ (å…å¯†ç¢¼)</button>
    </div>
</div>

<!-- ä½¿ç”¨è€…ç®¡ç†å½ˆçª— (New) -->
<div id="userMgmtOverlay" class="modal-overlay hidden">
    <div class="modal-box wide">
        <span class="modal-close" onclick="closeUserManagement()">Ã—</span>
        <div class="modal-title">å¸³è™Ÿç®¡ç†</div>
        
        <table class="user-list-table">
            <thead>
                <tr>
                    <th>å¸³è™Ÿ</th>
                    <th>å§“å</th>
                    <th style="text-align:center;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="userListBody">
                <!-- JS å¡«å…… -->
            </tbody>
        </table>

        <div class="new-user-form">
            <input type="text" id="newUsername" placeholder="æ–°å¸³è™Ÿ" autocomplete="off">
            <input type="text" id="newRealname" placeholder="å§“å/è·ç¨±" autocomplete="off">
            <input type="password" id="newPassword" placeholder="å¯†ç¢¼" autocomplete="off">
            <button class="btn green" style="width: auto; padding: 8px 12px;" onclick="addNewUser()">+ æ–°å¢</button>
        </div>
    </div>
</div>

<!-- èƒŒæ™¯è‰²ç¥¨å½ˆçª— -->
<div id="palettePopup" class="palette-popup">
    <!-- JS æœƒåœ¨æ­¤å¡«å……è‰²ç¥¨ -->
</div>

<!-- æ–‡å­—è‰²ç¥¨å½ˆçª— (New) -->
<div id="textColorPopup" class="palette-popup">
    <!-- JS æœƒåœ¨æ­¤å¡«å……è‰²ç¥¨ -->
</div>

<div class="container">
    <!-- å·¦å´ï¼šæ™‚ç¨‹è¡¨ -->
    <div class="left-panel">
        <div class="header-controls">
            <h1>äºŒå´™åœ‹å°å®šæœŸè©•é‡æ™‚ç¨‹</h1>
            
            <div class="btn-group admin-only">
                <button class="btn style-btn" onclick="toggleBold()" title="ç²—é«”">B</button>
                <!-- ä¿®æ”¹ï¼šé–‹å•Ÿæ–‡å­—è‰²ç¥¨å½ˆçª— -->
                <button class="btn style-btn" onclick="openTextColorPalette(this)" title="æ–‡å­—é¡è‰²">A</button>
                <!-- éš±è—åŸç”Ÿé¸è‰²å™¨ï¼Œä¾›å½ˆçª—è‡ªè¨‚ä½¿ç”¨ -->
                <input type="color" id="textColorPicker" onchange="changeTextColor(this.value)" style="display:none;">
            </div>
            
            <button class="btn edit-btn admin-only" onclick="addNewRow()">+æ–°å¢</button>
            
            <div class="btn-group admin-only">
                <button class="btn style-btn" onclick="adjustFontSize(2)" title="æ”¾å¤§å­—é«”">A+</button>
                <button class="btn style-btn" onclick="adjustFontSize(-2)" title="ç¸®å°å­—é«”">A-</button>
            </div>
            
            <button id="soundBtn" class="btn" onclick="toggleSound()">ğŸ”‡ éŸ³æ•ˆé—œ</button>

            <button class="btn blue admin-only" onclick="exportData()">ğŸ“¤ åŒ¯å‡º</button>
            <button class="btn blue admin-only" onclick="document.getElementById('importFile').click()">ğŸ“¥ åŒ¯å…¥</button>
            <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(this)">

            <!-- å·¦å´èƒŒæ™¯ç¨ç«‹æ§åˆ¶ (ä½¿ç”¨å½ˆçª—) -->
            <button class="btn admin-only" onclick="openPalette('left', this)">ğŸ¨ èƒŒæ™¯</button>
            <!-- éš±è—åŸæœ¬çš„ inputï¼Œæ”¹ç”±å½ˆçª—è§¸ç™¼ -->
            <input type="color" id="leftBgPicker" onchange="changeLeftBackgroundColor(this.value)" value="#ffffff" style="display:none;">

            <button id="lockBtn" class="btn orange admin-only" onclick="toggleLock()">ğŸ”“ è§£é–ä¸­</button>
            
            <button class="btn green admin-only" onclick="saveData()">ğŸ’¾ å­˜æª”</button>
            <!-- Google Sheet é›²ç«¯å­˜æª” -->
            <button class="btn blue admin-only" onclick="saveToGoogleSheets()" title="å‚™ä»½è‡³ Google Sheets">â˜ï¸ é›²ç«¯å­˜æª”</button>
            <button class="btn admin-only" onclick="setGoogleScriptUrl()" title="è¨­å®š Google Apps Script ç¶²å€" style="padding: 5px;">âš™ï¸</button>

            <button class="btn red admin-only" onclick="resetFactorySettings()">ğŸ”„ é‡ç½®</button>
            
            <div style="margin-left:auto;">
                <button class="btn" onclick="toggleFullscreen()" title="å…¨è¢å¹•æ¨¡å¼">ğŸ“º å…¨è¢å¹•</button>
                
                <!-- æ–°å¢ï¼šä½¿ç”¨è€…ç®¡ç†æŒ‰éˆ• -->
                <button class="btn admin-only" onclick="openUserManagement()" title="ç®¡ç†å¸³è™Ÿ">ğŸ‘¥ å¸³è™Ÿ</button>
                
                <button class="btn" id="userInfoBtn" disabled>æœªç™»å…¥</button>
                <button class="btn" onclick="handleLogout()">ç™»å‡º</button>
            </div>
        </div>

        <!-- åˆ†é åˆ‡æ›å™¨ -->
        <div class="tabs-container">
            <button class="tab-btn active" id="tab-day1" onclick="switchDay('day1')">ğŸ“… ç¬¬ä¸€å¤©è©•é‡</button>
            <button class="tab-btn" id="tab-day2" onclick="switchDay('day2')">ğŸ“… ç¬¬äºŒå¤©è©•é‡</button>
        </div>

        <table id="scheduleTable">
            <thead>
                <tr>
                    <th style="width: 15%;">ç§‘ç›®</th>
                    <th style="width: 25%;">æ™‚é–“</th>
                    <th style="width: 45%;">é€²åº¦èˆ‡å€’æ•¸</th> 
                    <th class="admin-only" style="width: 15%;">ç®¡ç†</th>
                </tr>
            </thead>
            <tbody>
                <!-- Javascript å°‡åœ¨æ­¤æ¸²æŸ“åˆ— -->
            </tbody>
        </table>
    </div>

    <!-- å³å´ï¼šå°å·¥å…· -->
    <div class="right-panel" id="widgetArea">
        <div class="widget-toolbar admin-only">
            <button class="btn edit-btn" onclick="createDigitalClock('white')">+æ•¸ä½(ç™½)</button>
            <button class="btn edit-btn" onclick="createDigitalClock('black')">+æ•¸ä½(é»‘ç¶ )</button>
            <button class="btn edit-btn" onclick="createAnalogClock()">+æŒ‡é‡æ™‚é˜</button>
            <button class="btn edit-btn" onclick="createStickyNote()">+ä¾¿åˆ©è²¼</button>
            <button class="btn edit-btn" onclick="createBulletin()">+å…¬å‘Šæ¬„</button>
            
            <!-- å³å´èƒŒæ™¯ç¨ç«‹æ§åˆ¶ (ä½¿ç”¨å½ˆçª—) -->
            <button class="btn" onclick="openPalette('right', this)">ğŸ¨ èƒŒæ™¯</button>
            <input type="color" id="rightBgPicker" onchange="changeRightBackgroundColor(this.value)" value="#fdf6e3" style="display:none;">
        </div>
        
        <!-- å°å·¥å…·å°‡ç”Ÿæˆæ–¼æ­¤ -->
    </div>
</div>

<script>
    // --- 0. å…¨åŸŸé…ç½® ---
    // è«‹å°‡æ‚¨çš„ Google Apps Script éƒ¨ç½²ç¶²å€å¡«å…¥ä¸‹æ–¹å¼•è™Ÿä¸­
    // ä¾‹å¦‚: "https://script.google.com/macros/s/AKfycbx.../exec"
    const CONFIG_GAS_URL = "https://script.google.com/macros/s/AKfycbxJVoTl8pqXNde7QUKn39fFP556OBwHeKmO7QfL86spJJPiYIdcRSvomVMCrkIFDXn6/exec"; 

    // --- 1. æ¬Šé™èˆ‡ç™»å…¥ç³»çµ± ---
    let currentUserRole = null; 
    let currentUserName = ""; 

    function handleLogin() {
        const user = document.getElementById('usernameInput').value.trim();
        const pass = document.getElementById('passwordInput').value.trim();
        const errorMsg = document.getElementById('loginError');

        const validUser = appState.users.find(u => u.username === user && u.password === pass);

        if (validUser) {
            setLoginState('admin', validUser.name || user);
        } else {
            errorMsg.textContent = "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤";
            document.getElementById('passwordInput').value = "";
        }
    }

    function handleGuestLogin() {
        setLoginState('guest');
    }

    function handleLogout() {
        currentUserRole = null;
        currentUserName = "";
        document.getElementById('loginOverlay').classList.remove('hidden');
        document.getElementById('passwordInput').value = "";
        document.getElementById('loginError').textContent = "";
        // ç™»å‡ºæ™‚é€€å‡ºå…¨è¢å¹•
        if (document.fullscreenElement) {
            document.exitFullscreen();
        }
        if(appState.isLocked && currentUserRole === 'admin') toggleLock(); 
    }

    function setLoginState(role, name = "è¨ªå®¢") {
        currentUserRole = role;
        currentUserName = name;
        const overlay = document.getElementById('loginOverlay');
        const userInfoBtn = document.getElementById('userInfoBtn');
        const body = document.body;

        overlay.classList.add('hidden');

        if (role === 'guest') {
            body.classList.add('guest-mode');
            userInfoBtn.textContent = "ğŸ‘¤ è¨ªå®¢";
            if (!appState.isLocked) {
                toggleLock(true);
            }
        } else {
            body.classList.remove('guest-mode');
            userInfoBtn.textContent = `ğŸ‘¤ ${name}`;
            updateLockUI();
        }
        renderTable();
    }
    
    function openUserManagement() {
        if(currentUserRole !== 'admin') return;
        document.getElementById('userMgmtOverlay').classList.remove('hidden');
        renderUserList();
    }
    
    function closeUserManagement() {
        document.getElementById('userMgmtOverlay').classList.add('hidden');
    }
    
    function renderUserList() {
        const tbody = document.getElementById('userListBody');
        tbody.innerHTML = "";
        
        appState.users.forEach(user => {
            const tr = document.createElement('tr');
            // åˆ¤æ–·æ˜¯å¦ç‚ºé è¨­ç®¡ç†å“¡æˆ–è‡ªå·±ï¼Œå¦‚æœæ˜¯å‰‡ä¸èƒ½åˆªé™¤ï¼Œä½†å¯ä»¥æ”¹å¯†ç¢¼
            const isSelf = user.username === document.getElementById('usernameInput').value;
            const isDefaultAdmin = user.username === 'admin';
            
            let actionButtons = `<button class="btn-sm" style="margin-right:5px;" onclick="changeUserPassword('${user.username}')">ğŸ”‘ ä¿®æ”¹å¯†ç¢¼</button>`;
            
            if (isDefaultAdmin && !isSelf) {
                actionButtons += `<span style="color:#aaa;">--</span>`;
            } else if (!isDefaultAdmin || !isSelf) {
                 if(!isDefaultAdmin && user.username !== 'admin') {
                     actionButtons += `<button class="btn-sm btn-del" onclick="deleteUser('${user.username}')">åˆªé™¤</button>`;
                 }
            }
            
            tr.innerHTML = `
                <td>${user.username}</td>
                <td>${user.name || '-'}</td>
                <td style="text-align:center;">${actionButtons}</td>
            `;
            tbody.appendChild(tr);
        });
    }
    
    function addNewUser() {
        const u = document.getElementById('newUsername').value.trim();
        const n = document.getElementById('newRealname').value.trim();
        const p = document.getElementById('newPassword').value.trim();
        
        if(!u || !p) {
            alert("å¸³è™Ÿèˆ‡å¯†ç¢¼ç‚ºå¿…å¡«ï¼");
            return;
        }
        
        if(appState.users.some(user => user.username === u)) {
            alert("æ­¤å¸³è™Ÿå·²å­˜åœ¨ï¼");
            return;
        }
        
        appState.users.push({
            username: u,
            password: p,
            name: n,
            role: 'admin' 
        });
        
        document.getElementById('newUsername').value = "";
        document.getElementById('newRealname').value = "";
        document.getElementById('newPassword').value = "";
        
        renderUserList();
        saveData(); 
        saveToGoogleSheets(); // è‡ªå‹•å‚™ä»½åˆ°é›²ç«¯
    }
    
    function changeUserPassword(username) {
        const newPass = prompt(`è«‹è¼¸å…¥ ${username} çš„æ–°å¯†ç¢¼ï¼š`);
        if(newPass) {
            const user = appState.users.find(u => u.username === username);
            if(user) {
                user.password = newPass;
                alert("å¯†ç¢¼å·²æ›´æ–°ï¼");
                renderUserList();
                saveData();
                saveToGoogleSheets(); // åŒæ­¥åˆ°é›²ç«¯
            }
        }
    }
    
    function deleteUser(username) {
        if(!confirm(`ç¢ºå®šè¦åˆªé™¤ä½¿ç”¨è€… ${username} å—ï¼Ÿ`)) return;
        appState.users = appState.users.filter(u => u.username !== username);
        renderUserList();
        saveData(); 
        saveToGoogleSheets();
    }


    // --- 2. è³‡æ–™èˆ‡ç‹€æ…‹ ---
    let appState = {
        isLocked: false,
        enableSound: false,
        leftBgColor: "#ffffff",
        rightBgColor: "#fdf6e3",
        gasUrl: CONFIG_GAS_URL || "", // åˆå§‹åŒ–æ™‚å„ªå…ˆä½¿ç”¨å¸¸æ•¸
        users: [
            { username: 'admin', password: '1234', name: 'é è¨­ç®¡ç†å“¡', role: 'admin' }
        ],
        currentDay: 'day1',
        schedules: {
            day1: [
                { id: 1, subject: "åœ‹èª", time: "08:00-09:00", style: { fontSize: 24, bold: true, color: "#000000" } },
                { id: 2, subject: "æ•¸å­¸", time: "09:10-10:10", style: { fontSize: 24, bold: true, color: "#000000" } },
                { id: 3, subject: "è‡ªç„¶", time: "10:30-11:30", style: { fontSize: 24, bold: true, color: "#000000" } }
            ],
            day2: [
                { id: 4, subject: "è‹±èª", time: "08:00-09:00", style: { fontSize: 24, bold: true, color: "#000000" } },
                { id: 5, subject: "ç¤¾æœƒ", time: "09:10-10:10", style: { fontSize: 24, bold: true, color: "#000000" } }
            ]
        },
        widgets: []
    };
    
    let playedAlerts = new Set(); 
    let audioCtx = null; 
    let focusedRowId = null;

    // --- 3. åˆå§‹åŒ–èˆ‡è®€å– ---
    window.onload = function() {
        loadData();
        // è‡ªå‹•å˜—è©¦å¾é›²ç«¯è¼‰å…¥ (å¦‚æœå·²æœ‰ç¶²å€)
        if(appState.gasUrl) {
            loadFromGoogleSheets(); 
        }
        
        renderTable();
        renderWidgets();
        applyGlobalSettings();
        updateLockUI();
        updateSoundUI(); 
        
        document.addEventListener('click', function(e) {
            const bgPopup = document.getElementById('palettePopup');
            const textPopup = document.getElementById('textColorPopup');
            
            if (!e.target.closest('#palettePopup') && !e.target.innerText.includes('ğŸ¨')) {
                bgPopup.classList.remove('show');
            }
            if (!e.target.closest('#textColorPopup') && e.target.title !== 'æ–‡å­—é¡è‰²' && e.target.innerText !== 'A') {
                textPopup.classList.remove('show');
            }
        });
    };

    function switchDay(day) {
        appState.currentDay = day;
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`tab-${day}`).classList.add('active');
        renderTable();
    }

    function sortRowsByTime() {
        const currentRows = appState.schedules[appState.currentDay];
        currentRows.sort((a, b) => {
            const timeA = a.time.split('-')[0] || "00:00";
            const timeB = b.time.split('-')[0] || "00:00";
            return timeA.localeCompare(timeB);
        });
        renderTable();
    }

    function loadData() {
        const savedData = localStorage.getItem('examScheduleState');
        if (savedData) {
            try {
                const parsed = JSON.parse(savedData);
                
                if(parsed.bgColor && !parsed.rightBgColor) {
                    parsed.rightBgColor = parsed.bgColor;
                    parsed.leftBgColor = "#ffffff";
                    delete parsed.bgColor;
                }
                
                if (parsed.rows && !parsed.schedules) {
                    parsed.schedules = {
                        day1: parsed.rows,
                        day2: []
                    };
                    delete parsed.rows;
                    parsed.currentDay = 'day1';
                }

                appState = { ...appState, ...parsed };
                if(!appState.widgets) appState.widgets = [];
                if(typeof appState.enableSound === 'undefined') appState.enableSound = false;
                
                // å¼·åˆ¶å„ªå…ˆä½¿ç”¨ç¨‹å¼ç¢¼ä¸­çš„å¸¸æ•¸ç¶²å€
                if (CONFIG_GAS_URL && CONFIG_GAS_URL.trim() !== "") {
                    appState.gasUrl = CONFIG_GAS_URL;
                } else if(!appState.gasUrl) {
                    appState.gasUrl = "";
                }

                if (!appState.users || appState.users.length === 0) {
                    appState.users = [{ username: 'admin', password: '1234', name: 'é è¨­ç®¡ç†å“¡', role: 'admin' }];
                }
                
            } catch (e) {
                console.error("è®€å–å­˜æª”å¤±æ•—", e);
            }
        }
        sortRowsByTime();
    }

    function saveData() {
        if(currentUserRole !== 'admin') return;
        collectWidgetsState();
        localStorage.setItem('examScheduleState', JSON.stringify(appState));
        const btn = document.querySelector('.btn.green');
        const originalText = btn.innerHTML;
        btn.innerHTML = "âœ… å·²å­˜æª”";
        setTimeout(() => btn.innerHTML = originalText, 1000);
    }
    
    function setGoogleScriptUrl() {
        if (CONFIG_GAS_URL && CONFIG_GAS_URL.trim() !== "") {
            const override = confirm("ç›®å‰ä½¿ç”¨ç¨‹å¼å…§å»ºçš„ç¶²å€ã€‚æ‚¨ç¢ºå®šè¦æš«æ™‚è¦†è“‹å®ƒå—ï¼Ÿ\n\n(é‡æ–°æ•´ç†ç¶²é å¾Œå°‡æ¢å¾©å…§å»ºå€¼)");
            if (!override) return;
        }
        const url = prompt("è«‹è¼¸å…¥ Google Apps Script ç™¼å¸ƒç¶²å€ (Web App URL):", appState.gasUrl);
        if (url !== null) {
            appState.gasUrl = url.trim();
            saveData(); 
            alert("ç¶²å€å·²æ›´æ–°ï¼");
        }
    }

    async function saveToGoogleSheets() {
        if (!appState.gasUrl) {
            // alert("è«‹å…ˆè¨­å®š Google Apps Script ç¶²å€ï¼");
            // setGoogleScriptUrl();
            return;
        }

        collectWidgetsState();
        const dataPayload = {
            timestamp: new Date().toLocaleString('zh-TW'),
            data: JSON.stringify(appState)
        };

        const btn = document.querySelector('button[onclick="saveToGoogleSheets()"]');
        if(btn) {
            var originalText = btn.innerHTML;
            btn.innerHTML = "â³ ä¸Šå‚³ä¸­...";
            btn.disabled = true;
        }

        try {
            await fetch(appState.gasUrl, {
                method: 'POST',
                mode: 'no-cors', 
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dataPayload)
            });
            if(btn) alert("å·²ç™¼é€è³‡æ–™è‡³ Google Sheetsï¼");
        } catch (error) {
            console.error("Error:", error);
            if(btn) alert("ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²å€æˆ–ç¶²è·¯é€£ç·šã€‚");
        } finally {
            if(btn) {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    }
    
    // å¾ Google Sheets è¼‰å…¥è³‡æ–™
    async function loadFromGoogleSheets() {
        if (!appState.gasUrl) return;
        // Check if URL is the placeholder
        if (appState.gasUrl.includes("your-script-id")) return;

        const loadingMsg = document.getElementById('loadingMsg');
        if(loadingMsg) loadingMsg.style.display = 'block';

        try {
            // Add a timestamp to prevent caching
            const fetchUrl = `${appState.gasUrl}?t=${new Date().getTime()}`;
            
            const response = await fetch(fetchUrl, {
                method: 'GET',
                redirect: 'follow'
                // mode: 'cors' is default
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            
            if(result.status === 'success' && result.data) {
                const cloudData = JSON.parse(result.data);
                appState = { ...appState, ...cloudData };
                
                // Refresh UI
                applyGlobalSettings();
                updateLockUI();
                updateSoundUI();
                sortRowsByTime();
                renderTable();
                renderWidgets();
                
                localStorage.setItem('examScheduleState', JSON.stringify(appState));
                console.log("é›²ç«¯è³‡æ–™å·²åŒæ­¥");
            }
        } catch (error) {
            console.error("ç„¡æ³•è¼‰å…¥é›²ç«¯è³‡æ–™:", error);
            // Optionally alert the user, but maybe too annoying on load
            // document.getElementById('loginError').textContent = "ç„¡æ³•é€£æ¥é›²ç«¯ (CORS æˆ– ç¶²å€éŒ¯èª¤)";
        } finally {
            if(loadingMsg) loadingMsg.style.display = 'none';
        }
    }

    function resetFactorySettings() {
        if(confirm("è­¦å‘Šï¼šæ­¤æ“ä½œå°‡æ¸…é™¤æ‰€æœ‰è¨­å®šã€èª²è¡¨è³‡æ–™èˆ‡èƒŒæ™¯è¨­å®šï¼Œæ¢å¾©ç‚ºç³»çµ±é è¨­å€¼ä¸”ç„¡æ³•å¾©åŸã€‚\n\nç¢ºå®šè¦é‡ç½®å—ï¼Ÿ")) {
            localStorage.removeItem('examScheduleState');
            location.reload();
        }
    }
    
    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                alert(`ç„¡æ³•å•Ÿç”¨å…¨è¢å¹•æ¨¡å¼: ${err.message}`);
            });
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }
    }
    
    function exportData() {
        collectWidgetsState();
        
        // P3: å®‰å…¨å„ªåŒ– - è¤‡è£½ç‹€æ…‹ä¸¦ç§»é™¤æ•æ„Ÿè³‡æ–™
        const stateToExport = JSON.parse(JSON.stringify(appState));
        delete stateToExport.users; // ç§»é™¤ä½¿ç”¨è€…å¸³è™Ÿå¯†ç¢¼
        
        const dataStr = JSON.stringify(stateToExport, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `exam_config_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function importData(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedState = JSON.parse(e.target.result);
                if (confirm("ç¢ºå®šè¦åŒ¯å…¥æ­¤è¨­å®šæª”å—ï¼Ÿé€™å°‡è¦†è“‹ç•¶å‰çš„æ‰€æœ‰è¨­å®šã€‚")) {
                    if(importedState.bgColor && !importedState.rightBgColor) {
                        importedState.rightBgColor = importedState.bgColor;
                        importedState.leftBgColor = "#ffffff";
                    }
                    if (importedState.rows && !importedState.schedules) {
                        importedState.schedules = { day1: importedState.rows, day2: [] };
                        delete importedState.rows;
                        importedState.currentDay = 'day1';
                    }

                    appState = { ...appState, ...importedState };
                    
                    // åŒ¯å…¥æ™‚ä¹Ÿå„ªå…ˆä½¿ç”¨å¸¸æ•¸ç¶²å€
                    if (CONFIG_GAS_URL && CONFIG_GAS_URL.trim() !== "") {
                        appState.gasUrl = CONFIG_GAS_URL;
                    }

                    applyGlobalSettings();
                    updateLockUI();
                    updateSoundUI();
                    sortRowsByTime(); 
                    renderTable();
                    renderWidgets();
                    saveData(); 
                    alert("åŒ¯å…¥æˆåŠŸï¼");
                }
            } catch (err) {
                alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼ŒåŒ¯å…¥å¤±æ•—ã€‚");
                console.error(err);
            }
            input.value = '';
        };
        reader.readAsText(file);
    }

    function collectWidgetsState() {
        const widgetElements = document.querySelectorAll('.draggable');
        appState.widgets = []; 
        widgetElements.forEach(el => {
            const left = el.style.left;
            const top = el.style.top;
            const type = el.dataset.type;
            let content = "";
            let contentTitle = "";
            if (type === 'sticky') {
                content = el.querySelector('textarea').value;
            } else if (type === 'bulletin') {
                content = el.querySelector('.bulletin-content').innerHTML;
                contentTitle = el.querySelector('.bulletin-title').innerHTML;
            }
            appState.widgets.push({
                id: el.dataset.id,
                type: type,
                left: left,
                top: top,
                content: content,
                contentTitle: contentTitle
            });
        });
    }

    // --- 3. æ¸²æŸ“èˆ‡é‚è¼¯ ---

    function renderTable() {
        const tbody = document.querySelector("#scheduleTable tbody");
        tbody.innerHTML = "";
        
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`tab-${appState.currentDay}`).classList.add('active');

        const currentRows = appState.schedules[appState.currentDay] || [];

        currentRows.forEach((row, index) => {
            const tr = document.createElement("tr");
            tr.dataset.id = row.id;
            tr.id = `row-${row.id}`; 
            
            const styleString = `
                font-size: ${row.style.fontSize}px; 
                font-weight: ${row.style.bold ? 'bold' : 'normal'}; 
                color: ${row.style.color};
            `;
            
            const isDisabled = appState.isLocked || currentUserRole === 'guest';
            const disabledClass = isDisabled ? 'input-disabled-look' : '';

            const timeParts = row.time.split('-');
            const startTime = timeParts[0] || "00:00";
            const endTime = timeParts[1] || "00:00";

            tr.innerHTML = `
                <td>
                    <input type="text" class="subject-input ${disabledClass}" value="${row.subject}" 
                        style="${styleString}"
                        onchange="updateRowData(${row.id}, 'subject', this.value)"
                        onfocus="setFocusedRow(${row.id})"
                        ${isDisabled ? 'disabled' : ''}
                    >
                </td>
                <td>
                    <div class="time-input-group">
                        <input type="time" class="time-part-input ${disabledClass}" value="${startTime}"
                             onchange="updateTimePart(${row.id}, 'start', this.value)"
                             ${isDisabled ? 'disabled' : ''}
                        >
                        <span>-</span>
                        <input type="time" class="time-part-input ${disabledClass}" value="${endTime}"
                             onchange="updateTimePart(${row.id}, 'end', this.value)"
                             ${isDisabled ? 'disabled' : ''}
                        >
                    </div>
                </td>
                <td>
                    <div class="energy-bar-container">
                        <div class="energy-bar-fill" id="bar-${row.id}"></div>
                        <span class="countdown-text" id="countdown-${row.id}">æœªé–‹å§‹</span>
                    </div>
                </td>
                <td class="manage-btns admin-only">
                    ${appState.isLocked ? '<span style="color:#aaa;">ğŸ”’ é–å®šä¸­</span>' : 
                    `<button class="btn-sm btn-del" onclick="deleteRow(${row.id})" title="åˆªé™¤æ­¤ç§‘ç›®">ğŸ—‘ï¸ åˆªé™¤</button>`}
                </td>
            `;
            tbody.appendChild(tr);
        });
        updateProgressBars();
    }

    function renderWidgets() {
        const widgetArea = document.getElementById('widgetArea');
        const existing = widgetArea.querySelectorAll('.draggable');
        existing.forEach(e => e.remove());
        appState.widgets.forEach(w => { restoreWidget(w); });
    }

    function addNewRow() {
        if(appState.isLocked || currentUserRole !== 'admin') return;
        const newId = Date.now();
        appState.schedules[appState.currentDay].push({ 
            id: newId, 
            subject: "æ–°ç§‘ç›®", 
            time: "08:00-09:00", 
            style: { fontSize: 24, bold: true, color: "#000000" }
        });
        sortRowsByTime(); 
    }

    function deleteRow(id) {
        if(appState.isLocked || currentUserRole !== 'admin') return;
        if(confirm("ç¢ºå®šåˆªé™¤æ­¤ç§‘ç›®ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚")) {
            appState.schedules[appState.currentDay] = appState.schedules[appState.currentDay].filter(item => item.id !== id);
            renderTable();
        }
    }

    function updateTimePart(id, part, value) {
        if(currentUserRole === 'guest') return;
        const item = appState.schedules[appState.currentDay].find(d => d.id === id);
        if(!item) return;

        const currentParts = item.time.split('-');
        let start = currentParts[0] || "00:00";
        let end = currentParts[1] || "00:00";

        if(part === 'start') start = value;
        if(part === 'end') end = value;

        item.time = `${start}-${end}`;
        
        playedAlerts.delete(`${id}-prep`);
        playedAlerts.delete(`${id}-end`);
        playedAlerts.delete(`${id}-2min-reminder`);
        
        sortRowsByTime();
    }

    function updateRowData(id, field, value) {
        if(currentUserRole === 'guest') return;
        const item = appState.schedules[appState.currentDay].find(d => d.id === id);
        if(item) item[field] = value;
    }

    // --- 4. æ¨£å¼æ§åˆ¶é‚è¼¯ ---
    function setFocusedRow(id) { focusedRowId = id; }
    function toggleBold() {
        if(appState.isLocked || !focusedRowId || currentUserRole !== 'admin') return;
        const item = appState.schedules[appState.currentDay].find(d => d.id === focusedRowId);
        if(item) { item.style.bold = !item.style.bold; renderTable(); }
    }
    
    function openTextColorPalette(btnElement) {
        if(appState.isLocked || currentUserRole !== 'admin') return;
        const popup = document.getElementById('textColorPopup');
        const textColors = ['#000000', '#333333', '#e74c3c', '#3498db', '#2ecc71', '#e67e22', '#9b59b6', '#34495e', '#795548'];
        let html = '';
        textColors.forEach(color => {
            html += `<div class="color-swatch" style="background-color: ${color};" onclick="applyTextColorFromPalette('${color}')"></div>`;
        });
        html += `<div class="custom-color-btn" onclick="document.getElementById('textColorPicker').click(); document.getElementById('textColorPopup').classList.remove('show');">è‡ªè¨‚...</div>`;
        popup.innerHTML = html;
        const rect = btnElement.getBoundingClientRect();
        popup.style.top = (rect.bottom + 5) + 'px';
        popup.style.left = rect.left + 'px';
        popup.classList.add('show');
        event.stopPropagation();
    }

    function applyTextColorFromPalette(color) {
        changeTextColor(color);
        document.getElementById('textColorPopup').classList.remove('show');
    }

    function changeTextColor(color) {
        if(appState.isLocked || !focusedRowId || currentUserRole !== 'admin') return;
        const item = appState.schedules[appState.currentDay].find(d => d.id === focusedRowId);
        if(item) { item.style.color = color; renderTable(); }
    }
    
    function adjustFontSize(delta) {
        if(appState.isLocked || !focusedRowId || currentUserRole !== 'admin') return;
        const item = appState.schedules[appState.currentDay].find(d => d.id === focusedRowId);
        if(item) {
            let newSize = item.style.fontSize + delta;
            if(newSize < 10) newSize = 10;
            if(newSize > 40) newSize = 40;
            item.style.fontSize = newSize;
            renderTable();
        }
    }
    
    let currentPickerSide = 'left';

    function openPalette(side, btnElement) {
        if(appState.isLocked || currentUserRole !== 'admin') return;
        
        currentPickerSide = side;
        const popup = document.getElementById('palettePopup');
        
        const themeColors = ['#fdf6e3', '#ffffff', '#fff0f5', '#eaf2f8', '#e8f8f5', '#f4ecf7'];

        let html = '';
        themeColors.forEach(color => {
            html += `<div class="color-swatch" style="background-color: ${color};" onclick="applyColor('${color}')"></div>`;
        });
        html += `<div class="custom-color-btn" onclick="openNativePicker()">è‡ªè¨‚...</div>`;
        
        popup.innerHTML = html;
        
        const rect = btnElement.getBoundingClientRect();
        popup.style.top = (rect.bottom + 5) + 'px';
        popup.style.left = rect.left + 'px';
        popup.classList.add('show');
        
        event.stopPropagation();
    }

    function applyColor(color) {
        if(currentPickerSide === 'left') {
            changeLeftBackgroundColor(color);
        } else {
            changeRightBackgroundColor(color);
        }
        document.getElementById('palettePopup').classList.remove('show');
    }

    function openNativePicker() {
        if(currentPickerSide === 'left') {
            document.getElementById('leftBgPicker').click();
        } else {
            document.getElementById('rightBgPicker').click();
        }
        document.getElementById('palettePopup').classList.remove('show');
    }

    function changeLeftBackgroundColor(color) {
        if(appState.isLocked || currentUserRole !== 'admin') return;
        appState.leftBgColor = color;
        applyGlobalSettings();
    }

    function changeRightBackgroundColor(color) {
        if(appState.isLocked || currentUserRole !== 'admin') return;
        appState.rightBgColor = color;
        applyGlobalSettings();
    }

    function applyGlobalSettings() {
        document.documentElement.style.setProperty('--left-bg-color', appState.leftBgColor);
        document.documentElement.style.setProperty('--right-bg-color', appState.rightBgColor);
        document.getElementById('leftBgPicker').value = appState.leftBgColor;
        document.getElementById('rightBgPicker').value = appState.rightBgColor;
    }

    // --- 5. é–å®šèˆ‡éŸ³æ•ˆé‚è¼¯ ---
    function toggleLock(forceState = null) {
        if (currentUserRole !== 'admin' && forceState === null) return;
        if (forceState !== null) {
            updateLockUI(forceState);
            if(currentUserRole === 'guest') {
                renderTable();
                updateWidgetLockState(true);
            }
            return;
        }
        appState.isLocked = !appState.isLocked;
        updateLockUI();
        renderTable(); 
        updateWidgetLockState(appState.isLocked);
    }
    function updateWidgetLockState(isLocked) {
        const widgets = document.querySelectorAll('.draggable');
        widgets.forEach(w => {
            if(isLocked) w.classList.add('locked');
            else w.classList.remove('locked');
            const inputs = w.querySelectorAll('textarea, [contenteditable]');
            inputs.forEach(i => {
                if(i.tagName === 'TEXTAREA') i.disabled = isLocked;
                else i.contentEditable = !isLocked;
            });
        });
    }
    function updateLockUI(forceState = null) {
        const btn = document.getElementById('lockBtn');
        const styleBtns = document.querySelectorAll('.style-btn');
        const editBtns = document.querySelectorAll('.edit-btn');
        const locked = forceState !== null ? forceState : appState.isLocked;
        if (locked) {
            btn.innerHTML = "ğŸ”’ å·²é–å®š";
            btn.className = "btn red admin-only";
            styleBtns.forEach(b => b.disabled = true);
            editBtns.forEach(b => b.disabled = true);
        } else {
            btn.innerHTML = "ğŸ”“ è§£é–ä¸­";
            btn.className = "btn orange admin-only";
            styleBtns.forEach(b => b.disabled = false);
            editBtns.forEach(b => b.disabled = false);
        }
    }
    
    function toggleSound() {
        appState.enableSound = !appState.enableSound;
        updateSoundUI();
        if(appState.enableSound && !audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if(appState.enableSound && audioCtx && audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
    }
    
    function updateSoundUI() {
        const btn = document.getElementById('soundBtn');
        if(appState.enableSound) {
            btn.innerHTML = "ğŸ”Š éŸ³æ•ˆé–‹";
            btn.classList.add("green");
        } else {
            btn.innerHTML = "ğŸ”‡ éŸ³æ•ˆé—œ";
            btn.classList.remove("green");
        }
    }

    function playAlert(type) {
        if(!appState.enableSound || !audioCtx) return;
        
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        
        if (type === 'prep') {
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(880, audioCtx.currentTime); 
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.2);
            
            const osc2 = audioCtx.createOscillator();
            const gain2 = audioCtx.createGain();
            osc2.connect(gain2);
            gain2.connect(audioCtx.destination);
            osc2.type = 'sine';
            osc2.frequency.setValueAtTime(880, audioCtx.currentTime + 0.3);
            gain2.gain.setValueAtTime(0.1, audioCtx.currentTime + 0.3);
            osc2.start(audioCtx.currentTime + 0.3);
            osc2.stop(audioCtx.currentTime + 0.5);
            
        } else if (type === 'end') {
            oscillator.type = 'triangle';
            oscillator.frequency.setValueAtTime(440, audioCtx.currentTime); 
            gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 2);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 2);
        }
    }

    // --- 7. æ™‚é–“è¨ˆç®—ã€å€’æ•¸æ–‡å­—èˆ‡éŸ³æ•ˆè§¸ç™¼ ---
    function updateProgressBars() {
        const now = new Date();
        const currentMinutes = now.getHours() * 60 + now.getMinutes();

        const currentRows = appState.schedules[appState.currentDay] || [];

        currentRows.forEach(row => {
            const bar = document.getElementById(`bar-${row.id}`);
            const textSpan = document.getElementById(`countdown-${row.id}`);
            const tr = document.getElementById(`row-${row.id}`); 
            
            if(!bar || !textSpan || !tr) return;

            const parts = row.time.split("-");
            if(parts.length !== 2) return;
            const startParts = parts[0].split(":");
            const endParts = parts[1].split(":");
            if(startParts.length < 2 || endParts.length < 2) return;

            const startMinutes = parseInt(startParts[0]) * 60 + parseInt(startParts[1]);
            const endMinutes = parseInt(endParts[0]) * 60 + parseInt(endParts[1]);
            const totalDuration = endMinutes - startMinutes;

            let statusText = "";

            if (currentMinutes < startMinutes) {
                bar.style.width = "0%";
                bar.style.backgroundColor = "#bdc3c7";
                const minsToStart = startMinutes - currentMinutes;
                statusText = `â³ é‚„æœ‰ ${minsToStart} åˆ†é˜é–‹å§‹`;
                textSpan.style.color = "#555";
                tr.classList.remove('active-exam-row'); 
            } else if (currentMinutes >= endMinutes) {
                bar.style.width = "100%";
                bar.style.backgroundColor = "#95a5a6";
                statusText = "ğŸ è€ƒè©¦çµæŸ";
                textSpan.style.color = "white";
                tr.classList.remove('active-exam-row'); 
                
                const alertKey = `${row.id}-end`;
                if (!playedAlerts.has(alertKey)) {
                    if(currentMinutes === endMinutes) {
                        playAlert('end');
                    }
                    playedAlerts.add(alertKey);
                }
                
            } else {
                const elapsed = currentMinutes - startMinutes;
                const percent = Math.min(100, Math.max(0, (elapsed / totalDuration) * 100));
                bar.style.width = percent + "%";
                
                tr.classList.add('active-exam-row');

                const remaining = endMinutes - currentMinutes;
                statusText = `ğŸ”¥ å‰©é¤˜ ${remaining} åˆ†é˜`;
                textSpan.style.color = "black";

                if (remaining <= 5) {
                    const alertKey = `${row.id}-prep`;
                    if (!playedAlerts.has(alertKey)) {
                        playAlert('prep');
                        playedAlerts.add(alertKey);
                    }
                }

                if (remaining <= 2 && remaining > 0) {
                    const reminderKey = `${row.id}-2min-reminder`;
                    if (!playedAlerts.has(reminderKey)) {
                        createStickyNote(null, "300px", "200px", "è€ƒè©¦æ™‚é–“é‚„å‰©2åˆ†é˜ï¼Œè«‹æª¢æŸ¥ç­ç´šã€å§“åæ˜¯å¦æœ‰å¡«å¯«ï¼Œè€ƒå·å…§å®¹è«‹å†æª¢æŸ¥ä¸€éã€‚", true);
                        playedAlerts.add(reminderKey);
                    }
                }

                if(percent < 50) bar.style.backgroundColor = "#2ecc71";
                else if(percent < 80) bar.style.backgroundColor = "#f1c40f";
                else {
                    bar.style.backgroundColor = "#e74c3c";
                    textSpan.style.color = "white"; 
                }
            }
            textSpan.textContent = statusText;
        });
    }
    setInterval(updateProgressBars, 1000); 

    // --- 8. å°å·¥å…·é‚è¼¯ (æ‹–æ›³ç­‰) ---
    let isDragging = false;
    let currentDragItem = null;
    let offsetX, offsetY;
    const GRID_SIZE = 20;

    document.addEventListener('mousedown', (e) => {
        const isLocked = appState.isLocked || currentUserRole === 'guest';
        if(isLocked) return;
        const target = e.target.closest('.draggable');
        if(target && !e.target.classList.contains('close-btn') && e.target.tagName !== 'TEXTAREA' && e.target.contentEditable !== 'true') {
            isDragging = true;
            currentDragItem = target;
            offsetX = e.clientX - target.offsetLeft;
            offsetY = e.clientY - target.offsetTop;
            target.style.zIndex = 100;
        }
    });
    
    document.addEventListener('mousemove', (e) => {
        if (!isDragging || !currentDragItem) return;
        let x = e.clientX - offsetX;
        let y = e.clientY - offsetY;
        x = Math.round(x / GRID_SIZE) * GRID_SIZE;
        y = Math.round(y / GRID_SIZE) * GRID_SIZE;
        currentDragItem.style.left = `${x}px`;
        currentDragItem.style.top = `${y}px`;
    });
    
    document.addEventListener('mouseup', () => {
        isDragging = false;
        if(currentDragItem) { currentDragItem.style.zIndex = 10; currentDragItem = null; }
    });

    const widgetArea = document.getElementById('widgetArea');
    
    function createWrapper(contentHTML, className = "", id = null, left="50px", top="100px", isSystemAction = false) {
        if(!isSystemAction) {
            if(appState.isLocked || currentUserRole !== 'admin') return null;
        }
        
        const div = document.createElement('div');
        div.className = `draggable ${className}`;
        div.style.left = left;
        div.style.top = top;
        div.dataset.id = id || Date.now();
        if(className.includes('clock-white')) div.dataset.type = 'clock-white';
        else if(className.includes('clock-black')) div.dataset.type = 'clock-black';
        else if(className.includes('analog')) div.dataset.type = 'analog';
        div.innerHTML = `<div class="close-btn" onclick="this.parentElement.remove()">Ã—</div>${contentHTML}`;
        
        if (appState.isLocked) {
            div.classList.add('locked');
            const inputs = div.querySelectorAll('textarea, [contenteditable]');
            inputs.forEach(i => {
                if(i.tagName === 'TEXTAREA') i.disabled = true;
                else i.contentEditable = false;
            });
        }

        widgetArea.appendChild(div);
        return div;
    }

    function createStickyNote(id=null, left, top, content="", isSystemAction = false) {
        const div = createWrapper(`<div class="sticky-note"><textarea placeholder="åœ¨æ­¤è¼¸å…¥ç­†è¨˜...">${content}</textarea></div>`, "", id, left, top, isSystemAction);
        if(div) div.dataset.type = 'sticky';
    }
    
    function createBulletin(id=null, left, top, title="ä»Šæ—¥å…¬å‘Š", content="é»æ“Šç·¨è¼¯å…§å®¹...") {
        const div = createWrapper(`<div class="bulletin-board"><div class="bulletin-title" contenteditable="true">${title}</div><div class="bulletin-content" contenteditable="true">${content}</div></div>`, "", id, left, top);
        if(div) div.dataset.type = 'bulletin';
    }
    function createDigitalClock(style, id=null, left, top) {
        const div = createWrapper(`<div class="digital-clock clock-${style}">00:00:00</div>`, "", id, left, top);
        if(!div) return;
        const display = div.querySelector('.digital-clock');
        function tick() { if(!document.body.contains(display)) return; display.textContent = new Date().toLocaleTimeString('zh-TW', { hour12: false }); requestAnimationFrame(tick); }
        tick();
    }
    function createAnalogClock(id=null, left, top) {
        let markersHTML = '';
        for(let i=0; i<60; i++) {
            const isHour = i % 5 === 0;
            const rotation = i * 6;
            const className = isHour ? 'clock-marker marker-hour' : 'clock-marker marker-minute';
            markersHTML += `<div class="${className}" style="transform: translateX(-50%) rotate(${rotation}deg);"></div>`;
        }

        const html = `
            <div class="analog-clock">
                <div class="clock-branding">QUARTZ</div>
                ${markersHTML}
                <div class="hand hour-hand"></div>
                <div class="hand min-hand"></div>
                <div class="hand sec-hand"></div>
                <div class="clock-center-cap"></div>
            </div>
        `;
        
        const div = createWrapper(html, "", id, left, top);
        if(!div) return;
        const hourHand = div.querySelector('.hour-hand');
        const minHand = div.querySelector('.min-hand');
        const secHand = div.querySelector('.sec-hand');
        function tick() {
            if(!document.body.contains(div)) return;
            const now = new Date();
            const s = now.getSeconds(); 
            const m = now.getMinutes(); 
            const h = now.getHours();
            const secDeg = s * 6;
            const minDeg = m * 6 + s * 0.1;
            const hourDeg = (h % 12) * 30 + m * 0.5;
            secHand.style.transform = `translateX(-50%) rotate(${secDeg}deg)`;
            minHand.style.transform = `translateX(-50%) rotate(${minDeg}deg)`;
            hourHand.style.transform = `translateX(-50%) rotate(${hourDeg}deg)`;
            requestAnimationFrame(tick);
        }
        tick();
    }
    function restoreWidget(w) {
        const wasLocked = appState.isLocked; const wasRole = currentUserRole;
        appState.isLocked = false; currentUserRole = 'admin'; 
        if (w.type === 'sticky') createStickyNote(w.id, w.left, w.top, w.content);
        else if (w.type === 'bulletin') createBulletin(w.id, w.left, w.top, w.contentTitle, w.content);
        else if (w.type === 'clock-white') createDigitalClock('white', w.id, w.left, w.top);
        else if (w.type === 'clock-black') createDigitalClock('black', w.id, w.left, w.top);
        else if (w.type === 'analog') createAnalogClock(w.id, w.left, w.top);
        appState.isLocked = wasLocked; currentUserRole = wasRole;
        if(currentUserRole === 'guest') updateWidgetLockState(true);
    }
</script>
</body>
</html>